{% extends "base.html" %}

{% block title %}結果一覧 - 物販リサーチ{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/jobs/{{ job.job_id }}" class="btn btn-outline-secondary btn-sm">&larr; ジョブ詳細に戻る</a>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>結果一覧</h2>
    <div class="btn-group" role="group">
        <a href="?pass_status=" class="btn btn-outline-secondary {% if not current_filter %}active{% endif %}">
            全て ({{ total }})
        </a>
        <a href="?pass_status=PASS" class="btn btn-outline-success {% if current_filter == 'PASS' %}active{% endif %}">
            合格 ({{ pass_count }})
        </a>
        <a href="?pass_status=REVIEW" class="btn btn-outline-warning {% if current_filter == 'REVIEW' %}active{% endif %}">
            要確認 ({{ review_count }})
        </a>
        <a href="?pass_status=FAIL" class="btn btn-outline-danger {% if current_filter == 'FAIL' %}active{% endif %}">
            不合格 ({{ fail_count }})
        </a>
    </div>
</div>

{% if items %}
<div class="table-responsive">
    <table class="table table-hover table-sm">
        <thead class="table-light">
            <tr>
                <th>候補</th>
                <th>ASIN</th>
                <th>商品名</th>
                <th>判定</th>
                <th class="text-end">販売価格</th>
                <th class="text-end">手数料</th>
                <th class="text-end">入金</th>
                <th class="text-end">仕入</th>
                <th class="text-end">利益額</th>
                <th class="text-end">利益率</th>
                <th class="text-end">ランク</th>
                <th class="text-end">30日</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr class="{% if item.is_candidate %}table-info{% endif %}">
                <td>
                    <input type="checkbox" class="form-check-input candidate-check"
                           data-item-id="{{ item.id }}"
                           {% if item.is_candidate %}checked{% endif %}>
                </td>
                <td>
                    <a href="https://www.amazon.co.jp/dp/{{ item.asin }}" target="_blank" class="font-monospace">
                        {{ item.asin }}
                    </a>
                </td>
                <td class="text-truncate" style="max-width: 200px;" title="{{ item.title or '-' }}">
                    {{ item.title or '-' }}
                </td>
                <td>
                    {% if item.pass_status == 'PASS' %}
                    <span class="badge bg-success">合格</span>
                    {% elif item.pass_status == 'REVIEW' %}
                    <span class="badge bg-warning text-dark">要確認</span>
                    {% elif item.pass_status == 'FAIL' %}
                    <span class="badge bg-danger">不合格</span>
                    {% else %}
                    <span class="badge bg-secondary">-</span>
                    {% endif %}
                </td>
                <td class="text-end">{{ "{:,}".format(item.amazon_price_fba_lowest) if item.amazon_price_fba_lowest else '-' }}</td>
                <td class="text-end">{{ "{:,}".format(item.amazon_fee_total) if item.amazon_fee_total else '-' }}</td>
                <td class="text-end">{{ "{:,}".format(item.amazon_payout) if item.amazon_payout else '-' }}</td>
                <td class="text-end">{{ "{:,}".format(item.rakuten_cost_net) if item.rakuten_cost_net else '-' }}</td>
                <td class="text-end fw-bold {% if item.profit_amount and item.profit_amount >= 1000 %}text-success{% endif %}">
                    {{ "{:,}".format(item.profit_amount) if item.profit_amount else '-' }}
                </td>
                <td class="text-end {% if item.profit_rate and item.profit_rate >= 0.15 %}text-success{% endif %}">
                    {{ "{:.1f}%".format(item.profit_rate * 100) if item.profit_rate else '-' }}
                </td>
                <td class="text-end">{{ "{:,}".format(item.rank_current) if item.rank_current else '-' }}</td>
                <td class="text-end">{{ item.sales_est_30 if item.sales_est_30 else '-' }}</td>
                <td>
                    <a href="/items/{{ item.id }}" class="btn btn-sm btn-outline-primary">詳細</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    該当するアイテムがありません。
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.candidate-check').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
        const itemId = this.dataset.itemId;
        const isCandidate = this.checked;

        fetch(`/api/items/${itemId}/candidate`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_candidate: isCandidate,
                user_memo: null
            })
        }).then(response => {
            if (response.ok) {
                this.closest('tr').classList.toggle('table-info', isCandidate);
            }
        });
    });
});
</script>
{% endblock %}
