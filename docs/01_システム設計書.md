# システム設計書

## 1. システム概要

### 1.1 目的
Keepa Product Finderで抽出した商品群（ASIN最大1,000件）を起点に、Amazon（最安FBA）× SP-API Fees Estimate × 楽天最安仕入れで利益判定を行い、条件を満たす商品を仕入れ候補としてDB保存し、Web画面で最終確認できるようにする。

### 1.2 システム名
物販リサーチアプリ v1.0

### 1.3 対象ユーザー
- 1人利用（v1.0）
- Amazon販売者（せどり/転売ビジネス）

---

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント                              │
│                    (Webブラウザ)                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FastAPI Application                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  Web Pages  │  │  REST API   │  │    Jinja2 Templates     │  │
│  │  (HTML)     │  │  (/api/*)   │  │                         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│                           │                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Service Layer                             ││
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌──────────────────┐  ││
│  │  │ Keepa   │ │ SP-API  │ │ Rakuten │ │ ProfitCalculator │  ││
│  │  │ Service │ │ Service │ │ Service │ │                  │  ││
│  │  └─────────┘ └─────────┘ └─────────┘ └──────────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│    MySQL    │        │    Redis    │        │  RQ Worker  │
│    8.0      │        │   7.0.15    │        │  (research) │
└─────────────┘        └─────────────┘        └─────────────┘
                                                      │
                              ┌───────────────────────┼───────────────────────┐
                              ▼                       ▼                       ▼
                       ┌───────────┐           ┌───────────┐           ┌───────────┐
                       │ Keepa API │           │  SP-API   │           │楽天API    │
                       └───────────┘           └───────────┘           └───────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| 言語 | Python | 3.12 |
| Webフレームワーク | FastAPI | 0.128+ |
| テンプレートエンジン | Jinja2 | 3.1+ |
| ORM | SQLAlchemy | 2.0+ |
| データベース | MySQL | 8.0 |
| キャッシュ/キュー | Redis | 7.0+ |
| ジョブキュー | RQ (Redis Queue) | 1.16+ |
| HTTPクライアント | httpx | 0.27+ |
| パッケージ管理 | uv | 0.9+ |

### 2.3 外部API

| API | 用途 | レート制限 |
|-----|------|-----------|
| Keepa API | 商品情報・ランキング・販売数推定 | 0.5 rps |
| Amazon SP-API | 価格・手数料・出品制限 | 1 rps |
| 楽天商品検索API | 仕入れ先検索 | 1 rps |
| 楽天製品検索API | JAN/型番マッチング | 1 rps |

---

## 3. 処理フロー

### 3.1 全体フロー

```
[ユーザー]
    │
    ▼
┌─────────────────────┐
│ 1. ASIN CSV投入     │
│    (最大1,000件)    │
└─────────────────────┘
    │
    ▼
┌─────────────────────┐
│ 2. ジョブ作成       │
│    - 重複排除       │
│    - DB登録         │
│    - キュー追加     │
└─────────────────────┘
    │
    ▼
┌─────────────────────┐     ┌─────────────────────┐
│ 3. RQワーカー処理   │────▶│ 1次スクリーニング   │
│                     │     │ (Keepa)             │
└─────────────────────┘     │ - ランキング取得    │
                            │ - 販売数推定        │
                            │ - 閾値チェック      │
                            └─────────────────────┘
                                │
                        ┌───────┴───────┐
                        ▼               ▼
                    [不合格]        [合格]
                        │               │
                        ▼               ▼
                ┌───────────┐   ┌─────────────────────┐
                │ FAIL保存  │   │ 2次確定 (SP-API)    │
                └───────────┘   │ - 最安FBA価格       │
                                │ - 手数料見積もり    │
                                │ - 出品制限確認      │
                                └─────────────────────┘
                                        │
                                        ▼
                                ┌─────────────────────┐
                                │ 楽天検索            │
                                │ - JAN/型番検索      │
                                │ - 最安候補抽出      │
                                │ - ポイント計算      │
                                └─────────────────────┘
                                        │
                                        ▼
                                ┌─────────────────────┐
                                │ 利益計算・判定      │
                                │ - 利益額算出        │
                                │ - 利益率算出        │
                                │ - PASS/FAIL/REVIEW  │
                                └─────────────────────┘
                                        │
                                        ▼
                                ┌─────────────────────┐
                                │ 結果保存            │
                                └─────────────────────┘
```

### 3.2 1次スクリーニング（Keepa）

**目的**: 明らかに条件を満たさない商品を早期に除外し、API呼び出しコストを削減

**取得データ**:
- 商品タイトル、ブランド、カテゴリ
- JANコード、型番
- 現在ランキング、30/90日平均ランキング
- 販売数推定（30/90/180日）
- セラー数、FBAセラー数
- 価格推移、ランキング推移（時系列）

**判定基準**:
- ランキング > 閾値 → 不合格
- 30日販売数 < 閾値 → 不合格
- 上記以外 → 2次確定へ

### 3.3 2次確定（SP-API + 楽天）

**SP-API取得データ**:
| API | データ |
|-----|--------|
| Product Pricing | 最安FBA価格、セラー数 |
| Product Fees | 販売手数料、FBA手数料 |
| Catalog Items | JAN/型番補完 |
| Listings Restrictions | 出品制限 |

**楽天検索フロー**:
1. JANコードで製品検索API → 製品特定
2. JAN/型番でIchiba商品検索 → 候補取得
3. 最安（商品+送料-ポイント）を選択
4. 候補一覧をDB保存

### 3.4 利益計算

```
入金価格 = 販売価格（最安FBA） - Amazon手数料（Fees Estimate）
仕入価格 = 楽天価格 + 送料 - ポイント還元
利益額   = 入金価格 - 仕入価格
利益率   = 利益額 / 入金価格
```

**判定ロジック**:
```python
if 利益額 < 閾値 or 利益率 < 閾値:
    return FAIL
elif ランキング不明 or 販売数不明 or 送料不明 or 楽天マッチなし:
    return REVIEW
else:
    return PASS
```

---

## 4. API仕様

### 4.1 REST API一覧

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/jobs/ | ジョブ作成 |
| GET | /api/jobs/ | ジョブ一覧取得 |
| GET | /api/jobs/{job_id} | ジョブ詳細取得 |
| POST | /api/jobs/{job_id}/retry | 失敗分リトライ |
| GET | /api/items/job/{job_id} | アイテム一覧取得 |
| GET | /api/items/{item_id} | アイテム詳細取得 |
| PATCH | /api/items/{item_id}/candidate | 仕入れ候補更新 |
| GET | /api/items/candidates/ | 仕入れ候補一覧 |

### 4.2 ジョブ作成 API

**リクエスト**:
```json
POST /api/jobs/
{
  "asins": ["B0XXXXXXXX", "B0YYYYYYYY", ...],
  "point_rate_normal": 0.01,
  "point_rate_spu": 0.07,
  "threshold_profit_amount": 1000,
  "threshold_profit_rate": 0.15,
  "threshold_rank": 50000,
  "threshold_sales_30": 10
}
```

**レスポンス**:
```json
{
  "job_id": "uuid",
  "status": "PENDING",
  "total_count": 100,
  "created_at": "2024-01-01T00:00:00"
}
```

### 4.3 アイテム一覧 API

**リクエスト**:
```
GET /api/items/job/{job_id}?pass_status=PASS&sort_by=profit_amount&sort_order=desc
```

**レスポンス**:
```json
{
  "items": [...],
  "total": 100,
  "pass_count": 20,
  "fail_count": 70,
  "review_count": 10
}
```

---

## 5. 非機能要件

### 5.1 レート制限対応

各APIのレート制限を個別に制御：

| API | 制限 | 実装 |
|-----|------|------|
| Keepa | 0.5 rps | time.sleep()で制御 |
| SP-API | 1 rps | time.sleep()で制御 |
| 楽天 | 1 rps | time.sleep()で制御 |

### 5.2 キャッシュ

- **TTL**: 24時間（デフォルト）
- **保存先**: MySQLのapi_cacheテーブル
- **キー**: API種別 + 識別子（ASIN等）

### 5.3 再開性

- ジョブ単位でステータス管理
- アイテム単位で処理ステータス管理
- 失敗分のみリトライ可能

### 5.4 セキュリティ

- APIキーは環境変数（.env）で管理
- .envはGit管理対象外（.gitignore）

---

## 6. ディレクトリ構成

```
fastapi-sandbox/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPIアプリケーション
│   ├── config.py            # 設定（環境変数）
│   ├── database.py          # DB接続
│   ├── api/                  # REST APIエンドポイント
│   │   ├── __init__.py
│   │   ├── jobs.py
│   │   └── items.py
│   ├── models/               # SQLAlchemyモデル
│   │   ├── __init__.py
│   │   ├── job.py
│   │   ├── item.py
│   │   ├── timeseries.py
│   │   ├── rakuten_candidate.py
│   │   └── cache.py
│   ├── schemas/              # Pydanticスキーマ
│   │   ├── __init__.py
│   │   ├── job.py
│   │   └── item.py
│   ├── services/             # ビジネスロジック
│   │   ├── __init__.py
│   │   ├── job_service.py
│   │   ├── item_service.py
│   │   ├── keepa.py
│   │   ├── sp_api.py
│   │   ├── rakuten.py
│   │   └── calculator.py
│   ├── workers/              # RQワーカー
│   │   ├── __init__.py
│   │   └── tasks.py
│   └── templates/            # Jinja2テンプレート
│       ├── base.html
│       ├── jobs/
│       └── items/
├── ddl/                      # DDL
│   └── 001_create_tables.sql
├── docs/                     # ドキュメント
├── static/                   # 静的ファイル
│   └── css/
├── tests/                    # テスト
├── .env                      # 環境変数（Git管理対象外）
├── .gitignore
├── pyproject.toml
└── uv.lock
```
