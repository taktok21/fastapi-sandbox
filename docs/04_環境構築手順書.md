# 環境構築手順書

## 1. 前提条件

### 1.1 必要なソフトウェア

| ソフトウェア | バージョン | 用途 |
|-------------|-----------|------|
| Python | 3.12以上 | アプリケーション実行 |
| uv | 0.9以上 | Pythonパッケージ管理 |
| MySQL | 8.0以上 | データベース |
| Redis | 7.0以上 | キャッシュ・ジョブキュー |
| Git | 2.x | ソースコード管理 |

### 1.2 APIキー

以下のAPIキーが必要です：

| API | 取得先 | 用途 |
|-----|--------|------|
| Keepa API Key | https://keepa.com/#!api | 商品情報・ランキング取得 |
| Amazon SP-API | Amazon Seller Central | 価格・手数料・出品制限 |
| 楽天アプリID | https://webservice.rakuten.co.jp/ | 楽天商品検索 |

---

## 2. 環境構築手順

### 2.1 リポジトリのクローン

```bash
git clone https://github.com/taktok21/fastapi-sandbox.git
cd fastapi-sandbox
```

### 2.2 Python依存パッケージのインストール

```bash
# uvをインストール（未インストールの場合）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 仮想環境作成と依存パッケージインストール
uv sync
```

### 2.3 MySQLのセットアップ

#### 2.3.1 MySQLのインストール（Ubuntu/Debian）

```bash
sudo apt update
sudo apt install mysql-server
```

#### 2.3.2 MySQLの起動

```bash
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### 2.3.3 データベースとユーザーの作成

```bash
sudo mysql
```

```sql
-- データベース作成
CREATE DATABASE appdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- ユーザー作成
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'apppass';
GRANT ALL PRIVILEGES ON appdb.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;

EXIT;
```

#### 2.3.4 テーブル作成

```bash
mysql -u appuser -papppass appdb < ddl/001_create_tables.sql
```

### 2.4 Redisのセットアップ

#### 2.4.1 Redisのインストール（Ubuntu/Debian）

```bash
sudo apt update
sudo apt install redis-server
```

#### 2.4.2 Redisの起動

```bash
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

#### 2.4.3 動作確認

```bash
redis-cli ping
# PONG と返ってくればOK
```

### 2.5 環境変数の設定

#### 2.5.1 .envファイルの作成

```bash
cp .env.example .env
```

#### 2.5.2 .envファイルの編集

```bash
# .env ファイルを編集
nano .env
```

```ini
# Database
DATABASE_URL=mysql+pymysql://appuser:apppass@127.0.0.1:3306/appdb?charset=utf8mb4

# Redis
REDIS_URL=redis://localhost:6379/0

# Keepa API
KEEPA_API_KEY=your_keepa_api_key_here

# Amazon SP-API
SP_API_REFRESH_TOKEN=your_refresh_token_here
SP_API_CLIENT_ID=your_client_id_here
SP_API_CLIENT_SECRET=your_client_secret_here
SP_API_MARKETPLACE_ID=A1VC38T7YXB528
SP_API_SELLER_ID=your_seller_id_here

# Rakuten API
RAKUTEN_APP_ID=your_rakuten_app_id_here

# Cache TTL (seconds)
CACHE_TTL_SECONDS=86400

# Rate Limits (requests per second)
RATE_LIMIT_KEEPA=0.5
RATE_LIMIT_SP_API=1.0
RATE_LIMIT_RAKUTEN=1.0
```

---

## 3. アプリケーションの起動

### 3.1 Webアプリケーション

```bash
# 仮想環境をアクティベート（必要な場合）
source .venv/bin/activate

# 開発サーバー起動
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

ブラウザで http://localhost:8000 にアクセス

### 3.2 RQワーカー（バックグラウンド処理）

```bash
# 別のターミナルで実行
source .venv/bin/activate
uv run rq worker research --with-scheduler
```

---

## 4. 動作確認

### 4.1 ヘルスチェック

```bash
curl http://localhost:8000/health
# {"status": "ok"} と返ってくればOK
```

### 4.2 Web画面アクセス

| URL | 画面 |
|-----|------|
| http://localhost:8000/ | トップ |
| http://localhost:8000/jobs | ジョブ一覧 |
| http://localhost:8000/jobs/create | 新規ジョブ作成 |

### 4.3 データベース接続確認

```bash
mysql -u appuser -papppass -e "SHOW TABLES;" appdb
```

期待される出力:
```
+------------------+
| Tables_in_appdb  |
+------------------+
| api_cache        |
| rakuten_candidate|
| research_item    |
| research_job     |
| research_timeseries |
+------------------+
```

---

## 5. トラブルシューティング

### 5.1 MySQL接続エラー

**症状**: `Access denied for user 'appuser'@'localhost'`

**解決策**:
```bash
sudo mysql
ALTER USER 'appuser'@'localhost' IDENTIFIED WITH mysql_native_password BY 'apppass';
FLUSH PRIVILEGES;
```

### 5.2 Redis接続エラー

**症状**: `Error 111 connecting to localhost:6379`

**解決策**:
```bash
# Redisが起動しているか確認
sudo systemctl status redis-server

# 起動していなければ起動
sudo systemctl start redis-server
```

### 5.3 ポート競合

**症状**: `Address already in use`

**解決策**:
```bash
# 使用中のプロセスを確認
lsof -i :8000

# プロセスを終了
kill -9 <PID>

# または別のポートで起動
uv run uvicorn app.main:app --reload --port 8001
```

### 5.4 パッケージインストールエラー

**症状**: `cryptography` ビルドエラー

**解決策**:
```bash
# ビルドツールをインストール
sudo apt install build-essential libssl-dev libffi-dev python3-dev
```

---

## 6. 開発用コマンド

### 6.1 コード整形

```bash
# Black（フォーマッター）
uv run black app/

# Ruff（リンター）
uv run ruff check app/
```

### 6.2 データベースリセット

```bash
# 全テーブル削除
mysql -u appuser -papppass appdb -e "DROP TABLE IF EXISTS api_cache, rakuten_candidate, research_timeseries, research_item, research_job;"

# 再作成
mysql -u appuser -papppass appdb < ddl/001_create_tables.sql
```

### 6.3 Redisデータクリア

```bash
redis-cli FLUSHALL
```

### 6.4 RQジョブ確認

```bash
# キュー内のジョブ確認
uv run rq info

# 失敗したジョブの確認
uv run rq info --only-failed
```

---

## 7. 本番環境向け設定

### 7.1 セキュリティ

1. **APIキーの管理**: 環境変数または秘密管理サービス（AWS Secrets Manager等）を使用
2. **データベースパスワード**: 強力なパスワードを設定
3. **.envファイル**: 本番環境では環境変数を直接設定

### 7.2 パフォーマンス

```bash
# 本番用起動（Gunicorn）
pip install gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# RQワーカー複数起動
rq worker research --with-scheduler &
rq worker research --with-scheduler &
```

### 7.3 ログ設定

```python
# app/config.py に追加
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

---

## 8. APIキー取得手順

### 8.1 Keepa API Key

1. https://keepa.com にアクセス
2. アカウント登録・ログイン
3. https://keepa.com/#!api でAPIキーを取得
4. トークン残高を購入（必要に応じて）

### 8.2 Amazon SP-API

1. Amazon Seller Centralにログイン
2. アプリとサービス > アプリの開発 > アプリを追加
3. LWA認証情報（Client ID, Client Secret）を取得
4. 自己認証でRefresh Tokenを取得

**必要な権限**:
- Pricing API
- Product Fees API
- Catalog Items API
- Listings Restrictions API

### 8.3 楽天アプリID

1. https://webservice.rakuten.co.jp/ にアクセス
2. アプリ登録
3. アプリIDを取得

---

## 9. ディレクトリ構成

```
fastapi-sandbox/
├── app/                    # アプリケーションコード
│   ├── __init__.py
│   ├── main.py            # FastAPIエントリポイント
│   ├── config.py          # 設定
│   ├── database.py        # DB接続
│   ├── api/               # REST API
│   ├── models/            # SQLAlchemyモデル
│   ├── schemas/           # Pydanticスキーマ
│   ├── services/          # ビジネスロジック
│   ├── workers/           # RQタスク
│   └── templates/         # Jinja2テンプレート
├── ddl/                   # DDLファイル
│   └── 001_create_tables.sql
├── docs/                  # ドキュメント
├── static/                # 静的ファイル
│   └── css/
├── .env                   # 環境変数（Git管理対象外）
├── .env.example           # 環境変数テンプレート
├── .gitignore
├── pyproject.toml         # 依存パッケージ定義
└── uv.lock                # 依存パッケージロック
```
