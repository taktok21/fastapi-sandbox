# DB設計書

## 1. 概要

### 1.1 データベース
- **DBMS**: MySQL 8.0
- **文字コード**: utf8mb4
- **照合順序**: utf8mb4_unicode_ci

### 1.2 接続情報
```
DATABASE_URL=mysql+pymysql://appuser:apppass@127.0.0.1:3306/appdb?charset=utf8mb4
```

---

## 2. ER図

```
┌─────────────────────┐
│   research_job      │
├─────────────────────┤
│ PK job_id           │
│    status           │
│    point_rate_*     │
│    threshold_*      │
│    *_count          │
│    created_at       │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐       ┌─────────────────────┐
│   research_item     │       │ research_timeseries │
├─────────────────────┤       ├─────────────────────┤
│ PK id               │       │ PK id               │
│ FK job_id           │◀──────│ FK job_id           │
│    asin             │       │    asin             │
│    process_status   │       │    metric           │
│    amazon_*         │       │    recorded_date    │
│    rakuten_*        │       │    value            │
│    profit_*         │       │    source           │
│    flag_*           │       └─────────────────────┘
│    pass_status      │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐
│ rakuten_candidate   │
├─────────────────────┤
│ PK id               │
│ FK job_id           │
│    asin             │
│    match_type       │
│    price            │
│    shipping         │
│    is_chosen        │
└─────────────────────┘

┌─────────────────────┐
│     api_cache       │
├─────────────────────┤
│ PK id               │
│ UK cache_key        │
│    api_type         │
│    response_data    │
│    expires_at       │
└─────────────────────┘
```

---

## 3. テーブル定義

### 3.1 research_job（リサーチジョブ）

ジョブの管理テーブル。1回のASIN投入で1レコード作成される。

| カラム名 | データ型 | NULL | キー | デフォルト | 説明 |
|---------|---------|------|------|-----------|------|
| job_id | CHAR(36) | NO | PK | - | UUID |
| status | ENUM | NO | IDX | 'PENDING' | ジョブステータス |
| point_rate_normal | DECIMAL(5,4) | NO | - | 0.0100 | 通常ポイント率 |
| point_rate_spu | DECIMAL(5,4) | NO | - | 0.0700 | SPUポイント率 |
| point_rate_total | DECIMAL(5,4) | NO | - | 0.0800 | 合計ポイント率 |
| threshold_profit_amount | INT | NO | - | 1000 | 利益額閾値（円） |
| threshold_profit_rate | DECIMAL(5,4) | NO | - | 0.1500 | 利益率閾値 |
| threshold_rank | INT | NO | - | 50000 | ランキング閾値 |
| threshold_sales_30 | INT | NO | - | 10 | 30日販売数閾値 |
| total_count | INT | NO | - | 0 | 総件数 |
| success_count | INT | NO | - | 0 | 成功件数 |
| fail_count | INT | NO | - | 0 | 失敗件数 |
| review_count | INT | NO | - | 0 | 要確認件数 |
| pass_count | INT | NO | - | 0 | 合格件数 |
| created_at | DATETIME | NO | IDX | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | NO | - | CURRENT_TIMESTAMP | 更新日時 |
| started_at | DATETIME | YES | - | NULL | 処理開始日時 |
| completed_at | DATETIME | YES | - | NULL | 処理完了日時 |

**ENUM: status**
- PENDING: 待機中
- RUNNING: 処理中
- DONE: 完了
- FAILED: 失敗

---

### 3.2 research_item（リサーチアイテム）

ASINごとの処理結果を保存するメインテーブル。

| カラム名 | データ型 | NULL | キー | デフォルト | 説明 |
|---------|---------|------|------|-----------|------|
| id | BIGINT | NO | PK | AUTO | 連番ID |
| job_id | CHAR(36) | NO | FK,UK | - | ジョブID |
| asin | VARCHAR(20) | NO | UK,IDX | - | Amazon ASIN |
| process_status | ENUM | NO | IDX | 'PENDING' | 処理ステータス |
| fail_reason | VARCHAR(500) | YES | - | NULL | 失敗理由 |

**商品基本情報**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| title | VARCHAR(500) | YES | 商品タイトル |
| jan_code | VARCHAR(20) | YES | JANコード |
| model_number | VARCHAR(100) | YES | 型番 |
| brand | VARCHAR(200) | YES | ブランド |
| category | VARCHAR(200) | YES | カテゴリ |

**Amazon価格・手数料**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| amazon_price_fba_lowest | INT | YES | 最安FBA価格（円） |
| amazon_fee_referral | INT | YES | 販売手数料（円） |
| amazon_fee_fba | INT | YES | FBA手数料（円） |
| amazon_fee_other | INT | YES | その他手数料（円） |
| amazon_fee_total | INT | YES | Amazon手数料合計（円） |
| amazon_payout | INT | YES | 入金価格（円） |

**楽天仕入れ**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| rakuten_match_type | ENUM | YES | 一致タイプ（JAN/MODEL/NONE/UNKNOWN） |
| rakuten_item_name | VARCHAR(500) | YES | 楽天商品名 |
| rakuten_shop_name | VARCHAR(200) | YES | 楽天ショップ名 |
| rakuten_item_url | VARCHAR(1000) | YES | 楽天商品URL |
| rakuten_price | INT | YES | 楽天商品価格（円） |
| rakuten_shipping | INT | YES | 楽天送料（円） |
| rakuten_shipping_status | ENUM | YES | 送料ステータス（FREE/PAID/UNKNOWN） |
| rakuten_point | INT | YES | 獲得ポイント（円相当） |
| rakuten_cost_gross | INT | YES | 楽天仕入れ総額（円） |
| rakuten_cost_net | INT | YES | 楽天仕入れ実質額（円） |

**利益計算**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| profit_amount | INT | YES | 利益額（円） |
| profit_rate | DECIMAL(5,4) | YES | 利益率（0.0000〜1.0000） |

**ランキング・販売数**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| rank_current | INT | YES | 現在ランキング |
| rank_avg_30 | INT | YES | 30日平均ランキング |
| rank_avg_90 | INT | YES | 90日平均ランキング |
| sales_est_30 | INT | YES | 30日販売数推定 |
| sales_est_90 | INT | YES | 90日販売数推定 |
| sales_est_180 | INT | YES | 180日販売数推定 |

**セラー情報**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| seller_count | INT | YES | 総セラー数 |
| fba_seller_count | INT | YES | FBAセラー数 |
| fba_lowest_seller_count | INT | YES | 最安FBAセラー数 |

**季節性**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| seasonality_flag | TINYINT(1) | YES | 季節性フラグ（1=あり, 0=なし, NULL=不明） |
| seasonality_score | DECIMAL(3,2) | YES | 季節性スコア（0.00〜1.00） |
| seasonality_note | VARCHAR(500) | YES | 季節性備考 |

**リスクフラグ**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| flag_hazardous | TINYINT(1) | YES | 危険物フラグ |
| flag_hazardous_status | ENUM | YES | 判定ステータス（AUTO/MANUAL/UNKNOWN） |
| flag_oversized | TINYINT(1) | YES | 大型商品フラグ |
| flag_oversized_status | ENUM | YES | 判定ステータス |
| flag_fragile | TINYINT(1) | YES | 割れ物フラグ |
| flag_fragile_status | ENUM | YES | 判定ステータス |
| flag_high_return | TINYINT(1) | YES | 返品率高フラグ |
| flag_high_return_status | ENUM | YES | 判定ステータス |
| flag_maker_restriction | TINYINT(1) | YES | メーカー規制フラグ |
| flag_maker_restriction_status | ENUM | YES | 判定ステータス |
| flag_authenticity_risk | TINYINT(1) | YES | 真贋リスクフラグ |
| flag_authenticity_risk_status | ENUM | YES | 判定ステータス |
| flag_listing_restriction | TINYINT(1) | YES | 出品制限フラグ |
| flag_listing_restriction_status | ENUM | YES | 判定ステータス |
| flag_memo | TEXT | YES | リスク備考 |

**判定結果**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| pass_status | ENUM | YES | 合否（PASS/FAIL/REVIEW） |
| pass_fail_reasons | JSON | YES | 不合格理由リスト |

**仕入れ候補**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| is_candidate | TINYINT(1) | NO | 仕入れ候補フラグ（デフォルト0） |
| user_memo | TEXT | YES | ユーザーメモ |

**タイムスタンプ**

| カラム名 | データ型 | NULL | 説明 |
|---------|---------|------|------|
| fetched_at | DATETIME | YES | データ取得日時 |
| created_at | DATETIME | NO | 作成日時 |
| updated_at | DATETIME | NO | 更新日時 |

**インデックス**

| 名前 | カラム | ユニーク |
|------|--------|---------|
| uk_job_asin | job_id, asin | YES |
| idx_item_job | job_id | NO |
| idx_item_asin | asin | NO |
| idx_item_process_status | process_status | NO |
| idx_item_pass_status | pass_status | NO |
| idx_item_profit | profit_amount | NO |
| idx_item_rank | rank_current | NO |
| idx_item_candidate | is_candidate | NO |
| idx_item_fetched | fetched_at | NO |

---

### 3.3 research_timeseries（時系列データ）

価格・ランキング・セラー数の推移を保存するテーブル。

| カラム名 | データ型 | NULL | キー | デフォルト | 説明 |
|---------|---------|------|------|-----------|------|
| id | BIGINT | NO | PK | AUTO | 連番ID |
| job_id | CHAR(36) | NO | FK,UK | - | ジョブID |
| asin | VARCHAR(20) | NO | UK,IDX | - | ASIN |
| metric | ENUM | NO | UK,IDX | - | メトリクス種別 |
| recorded_date | DATE | NO | UK,IDX | - | 記録日 |
| value | INT | YES | - | NULL | 値 |
| source | ENUM | NO | - | 'KEEPA' | データソース |
| created_at | DATETIME | NO | - | CURRENT_TIMESTAMP | 作成日時 |

**ENUM: metric**
- PRICE: 価格
- RANK: ランキング
- SELLER_COUNT: セラー数
- FBA_SELLER_COUNT: FBAセラー数

**ENUM: source**
- KEEPA: Keepa API
- SP_API: Amazon SP-API
- MANUAL: 手動入力

---

### 3.4 rakuten_candidate（楽天候補）

楽天検索の候補一覧を保存するテーブル。

| カラム名 | データ型 | NULL | キー | デフォルト | 説明 |
|---------|---------|------|------|-----------|------|
| id | BIGINT | NO | PK | AUTO | 連番ID |
| job_id | CHAR(36) | NO | FK,IDX | - | ジョブID |
| asin | VARCHAR(20) | NO | IDX | - | ASIN |
| match_type | ENUM | NO | IDX | - | 一致タイプ（JAN/MODEL/KEYWORD） |
| match_value | VARCHAR(100) | YES | - | NULL | 一致した値 |
| rakuten_item_code | VARCHAR(100) | YES | - | NULL | 楽天商品コード |
| item_name | VARCHAR(500) | YES | - | NULL | 商品名 |
| item_url | VARCHAR(1000) | YES | - | NULL | 商品URL |
| shop_code | VARCHAR(100) | YES | - | NULL | ショップコード |
| shop_name | VARCHAR(200) | YES | - | NULL | ショップ名 |
| price | INT | NO | IDX | - | 商品価格（円） |
| shipping | INT | YES | - | NULL | 送料（円） |
| shipping_status | ENUM | NO | - | 'UNKNOWN' | 送料ステータス |
| total_cost | INT | YES | - | NULL | 合計（円） |
| point_rate | DECIMAL(5,4) | YES | - | NULL | ポイント率 |
| point_rate_used | DECIMAL(5,4) | YES | - | NULL | 計算に使用したポイント率 |
| point_amount | INT | YES | - | NULL | ポイント額（円） |
| is_chosen | TINYINT(1) | NO | IDX | 0 | 採用フラグ |
| created_at | DATETIME | NO | - | CURRENT_TIMESTAMP | 作成日時 |

---

### 3.5 api_cache（APIキャッシュ）

APIレスポンスをキャッシュするテーブル。

| カラム名 | データ型 | NULL | キー | デフォルト | 説明 |
|---------|---------|------|------|-----------|------|
| id | BIGINT | NO | PK | AUTO | 連番ID |
| cache_key | VARCHAR(255) | NO | UK | - | キャッシュキー |
| api_type | ENUM | NO | IDX | - | API種別 |
| request_params | JSON | YES | - | NULL | リクエストパラメータ |
| response_data | JSON | NO | - | - | レスポンスデータ |
| fetched_at | DATETIME | NO | - | CURRENT_TIMESTAMP | 取得日時 |
| expires_at | DATETIME | NO | IDX | - | 有効期限 |

**ENUM: api_type**
- KEEPA: Keepa API
- SP_API_FEES: SP-API手数料
- SP_API_PRICING: SP-API価格
- SP_API_CATALOG: SP-APIカタログ
- SP_API_RESTRICTIONS: SP-API出品制限
- RAKUTEN_PRODUCT: 楽天製品検索
- RAKUTEN_SEARCH: 楽天商品検索

---

### 3.6 latest_research_item（VIEW）

ASINごとの最新結果を取得するビュー。

```sql
CREATE VIEW latest_research_item AS
SELECT ri.*
FROM research_item ri
INNER JOIN (
    SELECT asin, MAX(fetched_at) AS max_fetched
    FROM research_item
    WHERE process_status = 'SUCCESS'
    GROUP BY asin
) latest ON ri.asin = latest.asin AND ri.fetched_at = latest.max_fetched;
```

---

## 4. DDL

DDLファイル: `ddl/001_create_tables.sql`

```sql
-- 適用方法
mysql -u appuser -p appdb < ddl/001_create_tables.sql
```
